#!/bin/sh

# Prepare ------------------------------------------------------------------------------------------

main_color=15

# 1. CROSS-PLATFORM UPTIME FIX
# ----------------------------------------------------------------
get_uptime() {
    if uptime -p >/dev/null 2>&1; then
        # Linux (procps)
        uptime -p | cut -c 4- | cut -d ',' -f -2
    else
        # macOS / BSD
        # Captures text between "up" and "user"
        uptime | sed -E 's/.*up +(.*), [0-9]+ user.*/\1/'
    fi
}
# ----------------------------------------------------------------

info=$(gum style --border normal --padding '0 1' --width 30 --italic --foreground "${main_color}" \
"USER:   ${USER}@$(hostname)
UPTIME: $(get_uptime)")

art=$(gum style --foreground "${main_color}" 'â–„â–„â–„â–„â–„â–„â–„
â–ˆâ–„â–ˆâ–„â–ˆâ–ˆâ–ˆ
â–ˆâ–€  â–„â–€â–ˆ
â–ˆ â–„â–ˆâ–ˆ â–ˆ
â–ˆâ–ˆâ–„â–„â–„â–ˆâ–ˆ')

# Note: Used ANSI escape explicitly for portability in the color var
color=$(gum style '[0;90mï°¨   [0;91mï°¨   [0;92mï°¨   [0;93mï°¨   [0;94mï°¨   [0;95mï°¨   [0;96mï°¨   [0;97mï°¨ [0m')


# Display ------------------------------------------------------------------------------------------

terminal_size=$(stty size)
terminal_height=${terminal_size% *}
terminal_width=${terminal_size#* }

prompt_height=${PROMPT_HEIGHT:-1}

# 2. CROSS-PLATFORM WIDTH CALCULATION
# ----------------------------------------------------------------
get_max_width() {
    # Replaces 'wc --max-line-length' using awk (works everywhere)
    awk '{ if (length($0) > max) max = length($0) } END { print max + 0 }'
}
# ----------------------------------------------------------------

print_test() {
    # Strip ANSI codes portably
    no_color=$(printf '%b' "${1}" | sed "s/$(printf '\033')\[[0-9;]*[a-zA-Z]//g")

    # 3. FIXED WC FLAGS
    # ------------------------------------------------------------
    # Use -l instead of --lines
    line_count=$(printf '%s' "${no_color}" | wc -l | tr -d ' ')

    # Use awk function instead of --max-line-length
    max_width=$(printf '%s' "${no_color}" | get_max_width)
    # ------------------------------------------------------------

    [ "$line_count" -gt $(( terminal_height - prompt_height )) ] && return 1
    [ "$max_width" -gt "${terminal_width}" ] && return 1

    gum style --align center --width="${terminal_width}" "${1}" ''
    printf '%b' "\033[A"

}

clear

# Landscape layout
group_info_color=$(gum join --vertical --align center "${info}" "${color}")
print_test "$(gum join --horizontal --align center "${art}" '  ' "${group_info_color}")"

# Portrait layout
# print_test "$(gum join --vertical --align center "${art}" '' "${group_info_color}")"

# Other layout
# print_test "${group_info_color}"
# print_test "${info}"
echo
echo

exit 1
